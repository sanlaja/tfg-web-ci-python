{% extends "base.html" %}

{% block title %}Nuevo an&aacute;lisis Â· Simulador{% endblock %}

{% block content %}
<section class="page-header">
  <h1>Nuevo an&aacute;lisis</h1>
  <p class="muted">
    Completa el formulario para obtener una puntuaci&oacute;n autom&aacute;tica con observaciones accionables.
  </p>
</section>

<section class="card">
  <div class="card-section">
    <div class="field">
      <label class="muted" for="anl-ticker">Ticker</label>
      <input id="anl-ticker" name="ticker" placeholder="Ej. MSFT" autocomplete="off" />
    </div>
  </div>
</section>

<section id="modo-inversion" class="card">
  <div class="card-section">
    <h3>Modo de inversi&oacute;n</h3>
    <div class="field-group">
      <label>
        <input type="radio" name="modo" value="DCA" id="modo-dca" checked />
        DCA
      </label>
      <label>
        <input type="radio" name="modo" value="SIN_DCA" id="modo-sin-dca" />
        Sin DCA
      </label>
    </div>
  </div>
</section>

<section id="form-comun" class="card">
  <div class="card-section">
    <div class="form-grid">
      <div class="field">
        <label for="importe-inicial" class="muted">Importe inicial (&euro;)</label>
        <input
          type="number"
          id="importe-inicial"
          min="0"
          step="0.01"
          required
          inputmode="decimal"
        />
      </div>

      <div class="field">
        <label for="horizonte-anios" class="muted">Horizonte (a&ntilde;os, &ge;1)</label>
        <input
          type="number"
          id="horizonte-anios"
          min="1"
          step="1"
          required
          inputmode="numeric"
        />
      </div>

      <div class="field">
        <label for="crecimiento-estimado" class="muted">Crecimiento anual estimado (% opcional)</label>
        <input
          type="number"
          id="crecimiento-estimado"
          min="-100"
          max="100"
          step="0.01"
          placeholder="p. ej. 7.5"
          inputmode="decimal"
        />
      </div>

      <div class="field">
        <label for="margen-seguridad" class="muted">Margen de seguridad (% opcional)</label>
        <input
          type="number"
          id="margen-seguridad"
          min="0"
          max="100"
          step="0.01"
          placeholder="p. ej. 15"
          inputmode="decimal"
        />
      </div>
    </div>

    <div class="field">
      <label for="justificacion" class="muted">Justificaci&oacute;n</label>
      <textarea
        id="justificacion"
        rows="4"
        placeholder="Explica tu propuesta&hellip;"
      ></textarea>
    </div>
  </div>
</section>

<section id="form-dca" class="card">
  <div class="card-section">
    <h4>Par&aacute;metros DCA</h4>
    <div class="form-grid">
      <div class="field">
        <label for="dca-aporte" class="muted">Aportaci&oacute;n peri&oacute;dica (&euro;)</label>
        <input type="number" id="dca-aporte" min="0" step="0.01" inputmode="decimal" />
      </div>
      <div class="field">
        <label for="dca-frecuencia" class="muted">Frecuencia</label>
        <select id="dca-frecuencia">
          <option value="MONTHLY" selected>Mensual</option>
          <option value="WEEKLY">Semanal</option>
          <option value="QUARTERLY">Trimestral</option>
          <option value="ANNUAL">Anual</option>
        </select>
      </div>
      <div class="field">
        <label for="fechaInicioDCA" class="muted">Fecha inicio DCA</label>
        <input type="date" id="fechaInicioDCA" />
      </div>
      <div class="field">
        <label for="fechaFinDCA" class="muted">Fecha fin DCA</label>
        <input type="date" id="fechaFinDCA" />
      </div>
    </div>
  </div>
</section>

<section id="form-sin-dca" class="card" style="display:none">
  <div class="card-section">
    <p class="muted">
      Sin aportaciones peri&oacute;dicas. Solo se considera el importe inicial.
    </p>
    <div class="field">
      <label for="fechaCompra" class="muted">Fecha de compra</label>
      <input type="date" id="fechaCompra" />
    </div>
  </div>
</section>

<section class="card">
  <div class="card-section">
    <div class="actions">
      <button id="btn-enviar-propuesta" class="btn btn-primary">Enviar propuesta</button>
    </div>
  </div>
</section>

<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- Popup Precheck Yahoo Finance para revision -->
<div class="precheck-backdrop" id="precheck-modal" aria-hidden="true">
  <div class="precheck-dialog" role="dialog" aria-modal="true" aria-labelledby="precheck-title">
    <button class="precheck-close" id="precheck-close" aria-label="Cerrar">&times;</button>
    <h3 id="precheck-title">Antes de analizarâ€¦</h3>
    <p class="precheck-text">
      Hey, Â¿por quÃ© no le echas un vistazo a los datos mÃ¡s recientes antes de hacer tu anÃ¡lisis?
      Estoy seguro de que te serÃ¡n de mucha utilidad ðŸ˜‰
    </p>
    <div class="precheck-row">
      <input id="precheck-q" type="text" placeholder="Introduce el ticker o nombre de la empresaâ€¦" />
      <button id="precheck-open" class="btn btn-primary">Abrir en Yahoo Finance</button>
    </div>
  </div>
</div>

<div id="modalBacktest" class="modal hidden">
  <div class="modal__content">
    <button class="modal__close" id="modalBacktestClose">&times;</button>
    <h3 id="mb_titulo">Resumen de la inversi&oacute;n</h3>
    <div class="modal__body">
      <ul class="kv">
        <li><strong>Ticker:</strong> <span id="mb_ticker"></span></li>
        <li><strong>Periodo:</strong> <span id="mb_periodo"></span></li>
        <li><strong>Inversi&oacute;n inicial:</strong> <span id="mb_inv_ini"></span></li>
        <li><strong>Valor final:</strong> <span id="mb_valor_final"></span></li>
        <li><strong>PnL (importe):</strong> <span id="mb_pnl_abs"></span></li>
        <li><strong>PnL (%):</strong> <span id="mb_pnl_pct"></span></li>
        <li><strong>Precio inicial (ajustado):</strong> <span id="mb_p0a"></span></li>
        <li><strong>Precio final (ajustado):</strong> <span id="mb_p1a"></span></li>
        <li><strong>Variaci&oacute;n ajustada:</strong> <span id="mb_vara"></span></li>
        <li><strong>Precio inicial (sin ajustar):</strong> <span id="mb_p0"></span></li>
        <li><strong>Precio final (sin ajustar):</strong> <span id="mb_p1"></span></li>
        <li><strong>Variaci&oacute;n sin ajustar:</strong> <span id="mb_var"></span></li>
        <li><strong>Precio actual:</strong> <span id="mb_now"></span></li>
        <li><strong>Dividendos en periodo:</strong> <span id="mb_div"></span></li>
      </ul>
      <div class="modal__actions">
        <a id="mb_csv_adj" class="btn" target="_blank">Descargar CSV (ajustado)</a>
        <a id="mb_csv_raw" class="btn btn--sec" target="_blank">Descargar CSV (sin ajustar)</a>
      </div>
      <div id="mb_notes" class="notes"></div>
    </div>
  </div>
</div>
{% endblock %}
